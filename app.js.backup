const express = require('express');
const path = require('path');
const crypto = require('crypto');
const app = express();

app.use(express.json());

// ========================================
// CONFIGURA��O COM DOM�NIO FIXO
// ========================================
const FIXED_DOMAIN =
  'https://shopee-manager-604z8x8wp-raphaels-projects-11cd9f6b.vercel.app';
('https://shopee-manager-604z8x8wp-raphaels-projects-11cd9f6b.vercel.app');

const SHOPEE_CONFIG = {
  partner_id: '1185765',
  partner_key:
    'shpk52447844616d65636e77716a6a676d696c646947466d67496c4c584c6e52',
  redirect_url: `${FIXED_DOMAIN}/auth/shopee/callback`,
  base_domain: FIXED_DOMAIN,
  environment: 'sandbox',
  api_base: 'https://partner.test-stable.shopeemobile.com',
};

console.log('? Dom�nio fixo configurado:', FIXED_DOMAIN);

// Fun��o para gerar assinatura
const generateSignature = (path, timestamp, accessToken = '', shopId = '') => {
  const partnerId = SHOPEE_CONFIG.partner_id;
  const partnerKey = SHOPEE_CONFIG.partner_key;
  let baseString = `${partnerId}${path}${timestamp}`;
  if (accessToken) baseString += accessToken;
  if (shopId) baseString += shopId;
  return crypto
    .createHmac('sha256', partnerKey)
    .update(baseString)
    .digest('hex');
};

// Fun��o para gerar URL de autoriza��o
const generateAuthUrl = () => {
  const timestamp = Math.floor(Date.now() / 1000);
  const path = '/api/v2/shop/auth_partner';
  const signature = generateSignature(path, timestamp);
  return `${SHOPEE_CONFIG.api_base}${path}?partner_id=${SHOPEE_CONFIG.partner_id}&timestamp=${timestamp}&sign=${signature}&redirect=${encodeURIComponent(SHOPEE_CONFIG.redirect_url)}`;
};

// ========================================
// ARQUIVOS EST�TICOS
// ========================================
app.use('/css', express.static(path.join(__dirname, 'src', 'public', 'css')));
app.use('/js', express.static(path.join(__dirname, 'src', 'public', 'js')));
app.use(
  '/images',
  express.static(path.join(__dirname, 'src', 'public', 'images'))
);

// ========================================
// ROTAS PRINCIPAIS
// ========================================
app.get('/', (req, res) => res.redirect('/dashboard'));

app.get('/dashboard', (req, res) => {
  const dashboardPath = path.join(__dirname, 'src', 'views', 'dashboard.html');
  res.sendFile(dashboardPath);
});

// ========================================
// CALLBACK DA SHOPEE
// ========================================
app.get('/auth/shopee/callback', (req, res) => {
  const { code, shop_id, error } = req.query;

  console.log('?? Callback recebido:', {
    code: code?.substring(0, 10) + '...',
    shop_id,
    error,
    domain: FIXED_DOMAIN,
  });

  if (error) {
    return res.send(`
      <html>
        <head><title>Erro na Autoriza��o</title></head>
        <body style="font-family: Arial; text-align: center; padding: 50px; background: #ff6b6b; color: white;">
          <h1>? Erro na Autoriza��o</h1>
          <p><strong>Erro:</strong> ${error}</p>
          <p><strong>Dom�nio:</strong> ${FIXED_DOMAIN}</p>
          <button onclick="window.close()" style="padding: 10px 20px; background: white; color: #ff6b6b; border: none; border-radius: 5px; cursor: pointer;">Fechar</button>
        </body>
      </html>
    `);
  }

  if (code && shop_id) {
    console.log('?? SUCESSO! SUA LOJA CONECTADA:', {
      shop_id,
      code: code.substring(0, 20) + '...',
    });

    res.send(`
      <html>
        <head><title>?? SUA Loja Conectada!</title></head>
        <body style="font-family: Arial; text-align: center; padding: 50px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
          <div style="background: rgba(255,255,255,0.1); padding: 40px; border-radius: 15px; max-width: 700px; margin: 0 auto;">
            <div style="font-size: 6em; margin-bottom: 20px;">??</div>
            <h1>SUA LOJA SHOPEE CONECTADA!</h1>
            <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 10px; margin: 25px 0;">
              <p><strong>? Shop ID:</strong> ${shop_id}</p>
              <p><strong>? Authorization Code:</strong> ${code.substring(0, 30)}...</p>
              <p><strong>? Dom�nio Fixo:</strong> ${FIXED_DOMAIN}</p>
              <p><strong>? Status:</strong> CONECTADO COM SUCESSO!</p>
            </div>
            <h2>?? AGORA VOC� PODE:</h2>
            <div style="text-align: left; max-width: 500px; margin: 20px auto; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
              <ul style="list-style: none; padding: 0;">
                <li>??? Gerenciar seus milhares de produtos</li>
                <li>?? Atualizar pre�os em lote</li>
                <li>?? Controlar estoque</li>
                <li>?? Gerenciar promo��es</li>
                <li>?? Monitorar vendas</li>
                <li>?? Sincronizar dados</li>
              </ul>
            </div>
            <div style="margin-top: 30px;">
              <button onclick="window.close()" style="padding: 15px 30px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px; font-size: 16px;">
                Fechar Janela
              </button>
              <button onclick="window.location.href='/dashboard'" style="padding: 15px 30px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px; font-size: 16px;">
                Ir para Dashboard
              </button>
            </div>
          </div>
        </body>
      </html>
    `);
  } else {
    res.status(400).send(`
      <html>
        <head><title>Par�metros Inv�lidos</title></head>
        <body style="font-family: Arial; text-align: center; padding: 50px;">
          <h1>?? Par�metros Inv�lidos</h1>
          <p>Code: ${code || 'N�o recebido'}</p>
          <p>Shop ID: ${shop_id || 'N�o recebido'}</p>
          <p>Dom�nio: ${FIXED_DOMAIN}</p>
          <button onclick="window.close()">Fechar</button>
        </body>
      </html>
    `);
  }
});

// ========================================
// ROTAS DA SUA LOJA SHOPEE
// ========================================

// Configura��o e status
app.get('/api/my-shopee/setup', (req, res) => {
  res.json({
    success: true,
    configured: true,
    domain_fixed: true,
    partner_id_set: true,
    partner_key_set: true,
    message: 'SUA loja configurada com dom�nio fixo!',
    config: {
      partner_id: SHOPEE_CONFIG.partner_id,
      environment: SHOPEE_CONFIG.environment,
      fixed_domain: FIXED_DOMAIN,
      redirect_url: SHOPEE_CONFIG.redirect_url,
    },
    shopee_configuration: {
      domain_to_set: FIXED_DOMAIN,
      callback_endpoint: `${FIXED_DOMAIN}/auth/shopee/callback`,
    },
    status: 'ready_to_connect',
  });
});

// Conectar SUA loja
app.get('/api/my-shopee/connect', (req, res) => {
  try {
    const authUrl = generateAuthUrl();

    res.json({
      success: true,
      auth_url: authUrl,
      message: 'Clique no auth_url para conectar SUA loja Shopee',
      instructions: [
        '1. Configure o dom�nio na Shopee Open Platform primeiro',
        '2. Clique no auth_url abaixo',
        '3. Fa�a login na SUA conta Shopee (a que tem milhares de produtos)',
        '4. Autorize o acesso aos seus produtos',
        '5. Aguarde o redirecionamento autom�tico',
      ],
      domain_info: {
        fixed_domain: FIXED_DOMAIN,
        configure_in_shopee: FIXED_DOMAIN,
        callback_url: SHOPEE_CONFIG.redirect_url,
        partner_id: SHOPEE_CONFIG.partner_id,
      },
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao gerar URL de conex�o',
      error: error.message,
    });
  }
});

// Status da SUA loja
app.get('/api/my-shopee/status', (req, res) => {
  res.json({
    success: true,
    connected: false,
    message: 'Configure o dom�nio na Shopee e conecte sua loja',
    domain_status: 'fixed_domain_ready',
    fixed_domain: FIXED_DOMAIN,
    configure_in_shopee: FIXED_DOMAIN,
    next_steps: [
      '1. Configure o dom�nio na Shopee Open Platform',
      '2. Use /api/my-shopee/connect para gerar auth_url',
      '3. Clique na auth_url para conectar sua loja',
    ],
  });
});

// SEUS produtos
app.get('/api/my-shopee/products', (req, res) => {
  res.json({
    success: true,
    message:
      'Conecte sua loja primeiro para ver seus milhares de produtos reais',
    products: [],
    total: 0,
    status: 'awaiting_connection',
    fixed_domain: FIXED_DOMAIN,
    when_connected: {
      available_actions: [
        'Listar todos os seus produtos',
        'Atualizar pre�os em lote',
        'Gerenciar estoque',
        'Controlar promo��es',
        'Monitorar vendas',
      ],
    },
  });
});

// Dashboard da SUA loja
app.get('/api/my-shopee/dashboard', (req, res) => {
  res.json({
    success: true,
    message: 'Dashboard da SUA loja Shopee',
    fixed_domain: FIXED_DOMAIN,
    your_store_data: {
      total_products: 'Conecte sua loja',
      total_orders: 'Conecte sua loja',
      total_revenue: 'Conecte sua loja',
      pending_orders: 'Conecte sua loja',
      low_stock_products: 'Conecte sua loja',
      active_promotions: 'Conecte sua loja',
    },
    status: 'awaiting_connection',
    note: 'Conecte sua loja para ver os dados reais dos seus milhares de produtos',
  });
});

// ========================================
// APIs ORIGINAIS
// ========================================

app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    version: 'FIXED_DOMAIN_V1',
    timestamp: new Date().toISOString(),
    message: 'Shopee Manager - SUA Loja Real com dom�nio fixo!',
    fixed_domain: FIXED_DOMAIN,
    shopee_config: {
      partner_id: SHOPEE_CONFIG.partner_id,
      environment: SHOPEE_CONFIG.environment,
      domain_fixed: true,
    },
  });
});

app.get('/api/products', (req, res) => {
  res.redirect('/api/my-shopee/products');
});

app.get('/api/benchmarking', (req, res) => {
  res.json({
    success: true,
    message: 'Benchmarking dos SEUS produtos',
    note: 'Conecte sua loja para an�lise dos seus produtos',
    fixed_domain: FIXED_DOMAIN,
  });
});

app.get('/api/reports', (req, res) => {
  res.json({
    success: true,
    message: 'Relat�rios da SUA loja',
    available_reports: [
      'vendas_sua_loja',
      'estoque_seus_produtos',
      'performance_produtos',
    ],
    fixed_domain: FIXED_DOMAIN,
  });
});

// ========================================
// 404 HANDLER
// ========================================
app.use((req, res) => {
  res.status(404).json({
    error: '404 - N�o encontrado',
    path: req.path,
    method: req.method,
    fixed_domain: FIXED_DOMAIN,
    available_routes: [
      '/api/my-shopee/setup',
      '/api/my-shopee/connect',
      '/api/my-shopee/status',
      '/api/my-shopee/products',
      '/api/my-shopee/dashboard',
      '/api/health',
      '/auth/shopee/callback',
    ],
  });
});

// ========================================
// SERVIDOR
// ========================================
const PORT = process.env.PORT || 3000;

if (process.env.NODE_ENV !== 'production') {
  app.listen(PORT, () => {
    console.log(`?? Servidor rodando em http://localhost:${PORT}`);
    console.log(`?? Dom�nio fixo: ${FIXED_DOMAIN}`);
  });
}

module.exports = app;
